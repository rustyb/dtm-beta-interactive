<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Foursquare Store Locator</title>
    <link rel="stylesheet" href="map.css" type="text/css" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="shortcut icon" href="http://mapbox.com/images/favicon.ico" type="image/x-icon" />
</head>
<body class="left">
    <div id="content" style="display:none;"><div class="limiter">
        <h1>Store Locator</h1>
        <a id="showall" class="hidden" href="#">Address filter</a>
        <div id="no-venues" class="hidden">Oops! Looks like there are no <strong>sweetgreen</strong> locations within five miles of this address. Try another search.</div>
    </div></div>
    <div id="map" class="map"></div>
    <a href="https://foursquare.com/" target="_blank">
        <img id="fsq-attribution" src="img/powered-by.png">
    </a>
    <div id="search" style="display:none;">
       <form class="geocode">
         <input placeholder='Enter city, state, or ZIP' type="text">
         <input type='submit' />
         <div id='geocode-error'></div>
       </form>
    </div>

<script>

  function processToGeoJSON(features) {
    var trainFeatures = [];
    for (var i = 0; i < features.length; i++) {
        var t = features[i];
        trainFeatures.push({
            geometry: {
                coordinates: [
                  parseFloat(t.TrainLongitude),
                  parseFloat(t.TrainLatitude)]
            },
            properties: {
                direction: t.Direction,
                title: t.PublicMessage.replace(/\n/g, '<br />'),
                message: t.PublicMessage,
                status: t.TrainStatus,
                'marker-symbol': 'rail',
                'marker-color': '#2D6F83'
            }
        });
    }
    return trainFeatures;
  }


  mapbox.auto('map', 'http://a.tiles.mapbox.com/v3/rusty.map-dqtn0sfi.jsonp', function(map) {
    map.centerzoom({
      lat: 53.3428,
      lon: -6.2661}, 13);

    var markersLayer = mapbox.markers.layer();
    mapbox.markers.interaction(markersLayer);
    map.addLayer(markersLayer);
    updateTrains();

    function updateTrains() {
      reqwest({
          url: 'http://dtm-api.herokuapp.com/json_it.json?callback=?',
          type: 'jsonp',
          jsonCallback: 'callback',
        contentType: "application/json",
        accepts: "application/json",
        success: function(d) {
          var f = processToGeoJSON(d.ArrayOfObjTrainPositions.objTrainPositions);
          markersLayer.features(f);
          window.setTimeout(updateTrains, 10000);
      }});
    }
  });
</script>
</body>
</html>
