<!DOCTYPE html>
<html>
<head>
  <script src='http://api.tiles.mapbox.com/mapbox.js/v0.6.5/mapbox.js'></script>
  <link href='http://api.tiles.mapbox.com/mapbox.js/v0.6.4/mapbox.css' rel='stylesheet' />
  <script src="https://raw.github.com/ded/reqwest/master/reqwest.js"></script>
  
 <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />
  <title>DTM Beta</title>
  
  <!-- Included CSS Files (Uncompressed) -->
  <!--
<link rel="stylesheet" href="https://raw.github.com/rustyb/ipi-conf-2012/gh-pages/stylesheets/foundation.css">
  -->
  
  <!-- Included CSS Files (Compressed) -->
  <link rel="stylesheet" href="https://raw.github.com/rustyb/ipi-conf-2012/gh-pages/foundation/stylesheets/foundation.min.css">
  <link rel="stylesheet" href="https://raw.github.com/rustyb/ipi-conf-2012/gh-pages/foundation/stylesheets/app.css">
<link rel="stylesheet" href="https://raw.github.com/rustyb/ipi-conf-2012/gh-pages/foundation/custom.css">

  <script src="https://raw.github.com/rustyb/ipi-conf-2012/gh-pages/foundation/javascripts/modernizr.foundation.js"></script>

  <!-- IE Fix for HTML5 Tags -->
  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    .marker-popup {width:200px;}
  </style>
</head>
<body>
<div id='map'></div>
<script>

  function processToGeoJSON(features) {
    var trainFeatures = [];
    for (var i = 0; i < features.length; i++) {
        var t = features[i];
        trainFeatures.push({
            geometry: {
                coordinates: [
                  parseFloat(t.TrainLongitude),
                  parseFloat(t.TrainLatitude)]
            },
            properties: {
                direction: t.Direction,
                title: t.PublicMessage.replace(/\\n/g, "<br/>"),
                message: t.PublicMessage,
                status: t.TrainStatus,
                'marker-symbol': 'rail',
                'marker-color': '#2D6F83'
            }
        });
    }
    return trainFeatures;
  }


  mapbox.auto('map', 'http://a.tiles.mapbox.com/v3/rusty.map-dqtn0sfi.jsonp', function(map) {
    map.centerzoom({
      lat: 53.3428,
      lon: -6.2661}, 13);

    var markersLayer = mapbox.markers.layer();
    mapbox.markers.interaction(markersLayer);
    map.addLayer(markersLayer);
    updateTrains();

    // Set a custom formatter for tooltips
    // Provide a function that returns html to be used in tooltip
    markersLayer.interaction.formatter(function(feature) {
        var o = '<h2>' + feature.properties.direction + '</h2>' +
            '<p>' + feature.properties.message.replace(/\\n/g, "<br/>") + '</p>';

        return o;
    });
    
    function updateTrains() {
      reqwest({
          url: 'http://dtm-api.herokuapp.com/json_it.json?callback=?',
          type: 'jsonp',
          jsonCallback: 'callback',
        contentType: "application/json",
        accepts: "application/json",
        success: function(d) {
          var f = processToGeoJSON(d.ArrayOfObjTrainPositions.objTrainPositions);
          markersLayer.features(f);
          window.setTimeout(updateTrains, 10000);
      }});
    }
  });
</script>
    
</body>
</html>
